name: "Deploy to EKS (Auto)"

on:
  push:
    branches: [main]

env:
  AWS_REGION: us-east-2
  EKS_CLUSTER: eks-banca-ecosistema
  
  # CONFIGURACIÃ“N: MS-DEVOLUCIÃ“N
  NAMESPACE: switch
  ECR_REPO: switch-ms-devolucion
  SERVICE_NAME: switch-ms-devolucion
  CONTAINER_PORT: "8085"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: Build with Maven
        run: mvn clean package -DskipTests
      
      - name: Configurar AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login a ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Build y Push imagen
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/${{ env.ECR_REPO }}:$IMAGE_TAG .
          docker push $ECR_REGISTRY/${{ env.ECR_REPO }}:$IMAGE_TAG
          echo "IMAGE=$ECR_REGISTRY/${{ env.ECR_REPO }}:$IMAGE_TAG" >> $GITHUB_ENV
      
      - name: Configurar kubectl
        run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER }} --region ${{ env.AWS_REGION }}
      
      - name: Verificar o Crear Deployment
        run: |
          if kubectl get deployment ${{ env.SERVICE_NAME }} -n ${{ env.NAMESPACE }} > /dev/null 2>&1; then
            echo "âœ… Deployment existe, actualizando imagen..."
            kubectl set image deployment/${{ env.SERVICE_NAME }} \
              ${{ env.SERVICE_NAME }}=${{ env.IMAGE }} \
              -n ${{ env.NAMESPACE }}
          else
            echo "ðŸ“¦ Deployment no existe, creando..."
            cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ${{ env.SERVICE_NAME }}
            namespace: ${{ env.NAMESPACE }}
            labels:
              app: ${{ env.SERVICE_NAME }}
              component: devolucion
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: ${{ env.SERVICE_NAME }}
            template:
              metadata:
                labels:
                  app: ${{ env.SERVICE_NAME }}
              spec:
                containers:
                  - name: ${{ env.SERVICE_NAME }}
                    image: ${{ env.IMAGE }}
                    ports:
                      - containerPort: ${{ env.CONTAINER_PORT }}
                    resources:
                      requests:
                        memory: "512Mi"
                        cpu: "250m"
                      limits:
                        memory: "1Gi"
                        cpu: "500m"
                    env:
                      - name: SERVER_PORT
                        value: "${{ env.CONTAINER_PORT }}"
                      - name: SPRING_PROFILES_ACTIVE
                        value: "prod"
                      - name: SPRING_DATASOURCE_URL
                        valueFrom:
                          secretKeyRef:
                            name: switch-db-credentials
                            key: devolucion-url
                      - name: SPRING_DATASOURCE_USERNAME
                        valueFrom:
                          secretKeyRef:
                            name: switch-db-credentials
                            key: devolucion-username
                      - name: SPRING_DATASOURCE_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: switch-db-credentials
                            key: devolucion-password
                    livenessProbe:
                      httpGet:
                        path: /actuator/health/liveness
                        port: ${{ env.CONTAINER_PORT }}
                      initialDelaySeconds: 90
                      periodSeconds: 10
                      failureThreshold: 3
                    readinessProbe:
                      httpGet:
                        path: /actuator/health/readiness
                        port: ${{ env.CONTAINER_PORT }}
                      initialDelaySeconds: 60
                      periodSeconds: 5
                      failureThreshold: 3
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: ${{ env.SERVICE_NAME }}
            namespace: ${{ env.NAMESPACE }}
          spec:
            type: ClusterIP
            ports:
              - port: 80
                targetPort: ${{ env.CONTAINER_PORT }}
            selector:
              app: ${{ env.SERVICE_NAME }}
          EOF
          fi
      
      - name: Esperar Rollout
        run: |
          echo "â³ Esperando deployment..."
          kubectl rollout status deployment/${{ env.SERVICE_NAME }} \
            -n ${{ env.NAMESPACE }} --timeout=300s
          echo "âœ… Deploy completado!"
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=${{ env.SERVICE_NAME }}
